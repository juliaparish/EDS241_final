---
title: "EDS241: Take Home Final"
author: "Alex Clippinger"
date: '`r format(Sys.time(), "%m/%d/%Y")`'
output: 
  pdf_document:
    toc: false
    number_sections: yes
header-includes:
  - \setlength{\parindent}{1em}
  - \usepackage{float}
--- 

``` {r setup, echo = FALSE, message = FALSE, warning = FALSE}
# set default chunk options
knitr::opts_chunk$set(fig.width = 4, 
                      fig.height = 3, 
                      include = TRUE,
                      echo = TRUE, 
                      message = FALSE, 
                      warning = FALSE)

# load packages
packages=c("tidyverse", "tinytex", "estimatr", "car",
           "cowplot", "datasets", "tibble", "stringr", "here", 
           "kableExtra", "jtools", "stargazer", "AER")

for (i in packages) {
  if (require(i,character.only=TRUE)==FALSE) {
    install.packages(i,repos='http://cran.us.r-project.org')
  }
  else {
    require(i,character.only=TRUE)
  }
}

#devtools::install_github('rstudio/rmarkdown')
options(scipen=999) # not scientific notation

setwd("C:/Users/clipp/Documents/UCSB/EDS241/final_assignment/EDS241_final")
```

# Data

\noindent The following code loads and cleans the data.

```{r load_data}
# Load data
km_data <- read_csv("KM_EDS241.csv") %>% 
  mutate(nearinc = factor(nearinc))

# Create data frames for each year
km_81 <- km_data %>% filter(year==1981)
km_78 <- km_data %>% filter(year==1978)
```

# Question 1

\noindent (a) Using the data for 1981, estimate a simple OLS regression of real house values on the indicator for being located near the incinerator in 1981. What is the house value “penalty” for houses located near the incinerator? Does this estimated coefficient correspond to the ‘causal’ effect of the incinerator (and the negative amenities that come with it) on housing values? Explain why or why not.

```{r a, echo=FALSE}
model1 <- lm_robust(formula = rprice ~ nearinc, data = km_81)

tidy_model1 <- broom::tidy(model1)
tidy_model1 %>%
  dplyr::select(term, estimate, std.error, p.value) %>% 
  knitr::kable()
```

The house value "penalty" for houses located near the incinerator (nearinc=1) is $`r round(model1$coefficients[[2]], 2)`. This means that, based on this simple OLS regression, houses near the incinerator are, on average, worth $30,688 less than houses away from the incinerator. The estimated coefficient does not correspond to the causal effect of the incinerator because other confounding variables, such as age of the home, square footage, and number of rooms, are not taken into account.

\newpage
\noindent (b) Using the data for 1978, provide some evidence the location choice of the incinerator was not “random”, but rather selected on the basis of house values and characteristics. [Hint: in the 1978 sample, are house values and characteristics balanced by nearinc status?]

```{r b}
price_difference = mean(km_78[km_78$nearinc==0,]$rprice) - mean(km_78[km_78$nearinc==1,]$rprice)
area_difference = mean(km_78[km_78$nearinc==0,]$area) - mean(km_78[km_78$nearinc==1,]$area)
rooms_difference = mean(km_78[km_78$nearinc==0,]$rooms) - mean(km_78[km_78$nearinc==1,]$rooms)
```

Prior to "treatment" (i.e., the construction of the incinerator), the mean average value of a home was $`r round(price_difference, 2)` higher for the houses that would be away from the incinerator than for the houses that would be close to the incinerator in 1981. This positive difference indicates that homes further from the incinerator were valued higher (on average) prior to construction, which could mean that the location of construction was not random, but instead selected based on existing home value. Additionally, homes away from construction had `r round(area_difference, 2)` greater square footage and `r round(rooms_difference, 2)` more rooms, on average, supporting the claim that the location of construction was based on home characteristics. These relationships can be examined using simple OLS regression.

```{r b_evidence1, echo=FALSE, fig.cap="Relationship between price and proximity prior to construction"}
lm_robust(rprice ~ nearinc, km_78) %>% 
  tidy() %>% 
  select(term, estimate, std.error, p.value) %>% 
  kable()
```

The first regression shows that there the average home value is statistically significantly lower for homes near the incinerator prior to construction.

```{r b_evidence2, echo=FALSE, fig.cap="Relationship between area and proximity prior to construction"}
lm_robust(area ~ nearinc, km_78) %>% 
  tidy() %>% 
  select(term, estimate, std.error, p.value) %>% 
  kable()
```

The second regression shows that the average home square footage is statistically significantly (p<0.05) lower for home near the incinerator prior to construction. 

```{r b_evidence3, echo=FALSE, fig.cap="Relationship between rooms and proximity prior to construction"}
lm_robust(rooms ~ nearinc, km_78) %>% 
  tidy() %>% 
  select(term, estimate, std.error, p.value) %>% 
  kable()
```

The third regression shows that the average number of rooms was statistically significantly lower for homes near the incinerator prior to construction.


\noindent (c) Based on the observed differences in (b), explain why the estimate in (a) is likely to be biased downward (i.e., overstate the negative effect of the incinerator on housing values).


```{r c}

```



\noindent (d) Use a difference-in-differences (DD) estimator to estimate the causal effect of the incinerator on housing values without controlling for house and lot characteristics. Interpret the magnitude and sign of the estimated DD coefficient. 

```{r d}

```



\noindent (e) Report the 95% confidence interval for the estimate of the causal effect on the incinerator in (d).

```{r e}

```



\noindent (f) How does your answer in (d) changes when you control for house and lot characteristics? Test the hypothesis that the coefficients on the house and lot characteristics are all jointly equal to 0.

```{r f}

```



\noindent (g)  Using the results from the DD regression in (f), calculate by how much did real housing values change on average between 1978 and 1981.


```{r g}

```



\noindent (h) Explain (in words) what is the key assumption underlying the causal interpretation of the DD estimator in the context of the incinerator construction in North Andover.

```{r h}

```


